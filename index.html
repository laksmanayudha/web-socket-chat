<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Simple Chats</title>
    <link rel="stylesheet" href="./adminlte/adminlte.min.css">
    <link rel="stylesheet" href="./adminlte/fontawesome.min.css">
    <link rel="stylesheet" href="./css/main.css">
  </head>
  <body>
    <main class="container-fluid  p-2 d-flex flex-column justify-content-center align-items-center">
        <header class="navigation my-3">
            <button class="btn btn-primary mr-3 d-md-none" id="openSidebar">=</button>
            <h3>Simple Chats</h3>
        </header>
        <div class="row w-100 border rounded p-2">
            <aside class="col-12 col-md-4 sidebar">
                <div class="mt-2 d-flex justify-content-end d-md-none">
                    <button class="btn bg-maroon" id="closeSidebar">Close</button>
                </div>
                <div class="mt-2">
                    <form action="#" id="addUserForm" name="addUserForm">
                        <div class="card card-outline card-maroon">
                            <div class="card-header">
                                <div class="card-title">
                                    <h5>Add User</h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="from">User Name</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="username" id="username" placeholder="User name">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary">Add</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="mt-2">
                    <form action="#" id="chatForm" name="chatForm">
                        <div class="card card-outline card-teal">
                            <div class="card-header">
                                <div class="card-title">
                                    <h5>Chat Now</h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="from">From</label>
                                    <select class="form-control" name="from" id="from">
                                        <option value="">Select User</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="target">Target</label>
                                    <input type="hidden" name="target" id="target">
                                    <ul class="contact-lists px-2" id=" contactLists">
                                    </ul>
                                </div>
                            </div>
                            <div class="card-footer">
                                <strong>Created By</strong> YudhaL
                            </div>
                        </div>
                    </form>
                </div>
            </aside>
            <div class="col-12 col-md-8">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-primary card-outline direct-chat direct-chat-primary mt-2">
                            <div class="card-header">
                              <span class="card-title">Direct Chat</span>
                            </div>
                            <div class="card-body">
                                <div class="direct-chat-messages" id="chatContainer">
                                    
                                </div>
                            </div>
                            <div class="card-footer">
                              <form action="#" method="post" name="chatForm">
                                <div class="input-group">
                                  <input type="text" name="chat" placeholder="Type Message ..." class="form-control">
                                  <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">Send</button>
                                  </div>
                                </div>
                              </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- template -->
    <template id="rightMessage">
        <div class="direct-chat-msg right">
            <div class="direct-chat-infos clearfix">
              <span class="direct-chat-name float-right" id="name">User Name</span>
            </div>
            <div class="direct-chat-img bg-primary d-flex justify-content-center align-items-center"><i class="fas fa-user"></i></div>
            <div class="direct-chat-text" id="chat">
                User Message
            </div>
        </div>
    </template>

    <template id="leftMessage">
        <div class="direct-chat-msg">
            <div class="direct-chat-infos clearfix">
              <span class="direct-chat-name float-left" id="name">Target Name</span>
            </div>
            <div class="direct-chat-img bg-danger d-flex justify-content-center align-items-center"><i class="fas fa-user"></i></div>
            <div class="direct-chat-text" id="chat">
                Message sent
            </div>
        </div>
    </template>

    <template id="contactItem">
        <li class="contact-item d-flex align-items-center border p-2 rounded mt-2">
            <div class="user-img-thumb bg-danger d-flex justify-content-center align-items-center mr-2">
                <i class="fas fa-user"></i>
            </div>
            <span class="user-thumb-display">User name</span>
            <input type="hidden" name="userThumbName" value="username">
        </li>
    </template>

    <!-- script -->
    <script src="./adminlte/jquery.min.js"></script>
    <script src="./adminlte/adminlte.min.js"></script>
    <script>
        let socket = new WebSocket('ws://localhost:8080/websocket');
        const api = 'http://localhost:8080';

        socket.onopen = function(e) {
            console.log('[open] web socket established');
        }

        socket.onmessage = function(e) {
            let response = event.data;
            const { status, message, data } = JSON.parse(response);

            if (status === 'success') {
                if (data.user != userInput.value) {
                    insertMessage({
                        user: data.user,
                        chat: data.chat,
                        type: 'left'
                    });
                }
            }

            // delete message
        }

        socket.onclose = function(e) {
            console.log('[closed] web socket closed');
        }

        function setStorage(key, value) {
            localStorage.setItem(key, value);
        }

        function getStorage(key) {
            return localStorage.getItem(key) || '';
        }

        async function fetchData(url, option) {
            let data = null;
            try {
                const data = await fetch(url, option);
                const json = await data.json();
                data = json;
            } catch (error) {
                console.log(error)
            }
            return data;
        }

        async function setUsers() {
            const response = await fetchData(`${api}/users`);
            if (!response) return;
            const { data: { users } } = response;
            
            // set from select
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.innerHTML = user.name;
                $('#from').append(option);
            });

            // set target
            const contactItemContent = document.querySelector('#contactItem').content;
            users.forEach(user => {
                let content = contactItemContent.cloneNode(true);
                content.querySelector('.user-thumb-display').innerHTML = user.name;
                content.querySelector('[name="userThumbName"]').innerHTML = user.name;
                content.querySelector('[name="userThumbName"]').value = user.name;
                $('.contact-lists').append(content);
            });
        }

        function insertMessage({ user, chat, type }) {
            const chatContainer = document.getElementById('chatContainer');
            let template = null;

            if (type == 'left') {
                template = document.getElementById('leftMessage');
            } else {
                template = document.getElementById('rightMessage');
            }
            // clone template
            const content = template.content.cloneNode(true);
            
            // fill template
            content.querySelector('#name').innerHTML = user;
            content.querySelector('#chat').innerHTML = chat;

            // append chat
            chatContainer.append(content);

            return content;
        }

        $('#openSidebar').click(function(e) {
            $('.sidebar').addClass('sidebar--open');
        });

        $('#closeSidebar').click(function(e) {
            $('.sidebar').removeClass('sidebar--open');
        });

        setUsers();
    </script>
  </body>
</html>